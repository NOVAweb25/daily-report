<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>سجل يومي للموظفين</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Tajawal', 'Arial', sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
      margin: 0; padding: 20px; 
    }
    .container { max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
    .date { text-align: center; color: #7f8c8d; font-size: 18px; margin-bottom: 20px; }
    .card { 
      background: white; border-radius: 16px; padding: 20px; 
      margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
    }
    .card h3 { margin: 0 0 15px; color: #2c3e50; display: flex; justify-content: space-between; align-items: center; }
    .section { 
      background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; 
      border: 1px solid #e0e0e0; 
    }
    input, textarea { 
      width: 100%; padding: 12px; margin: 8px 0; 
      border: 1px solid #ddd; border-radius: 10px; 
      font-size: 16px; transition: 0.3s; 
    }
    input:focus, textarea:focus { border-color: #3498db; outline: none; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .add-btn { 
      width: 44px; height: 44px; border-radius: 50%; 
      background: #27ae60; color: white; border: none; 
      font-size: 24px; cursor: pointer; 
      box-shadow: 0 4px 15px rgba(39,174,96,0.4); 
      transition: 0.3s; display: block; margin: 10px auto;
    }
    .add-btn:hover { transform: scale(1.1); }
    .toggle { 
      background: #3498db; color: white; border: none; 
      padding: 6px 12px; border-radius: 20px; 
      font-size: 12px; cursor: pointer; 
    }
    .submit-btn { 
      background: #e74c3c; color: white; padding: 16px; 
      border: none; border-radius: 12px; font-size: 18px; 
      cursor: pointer; width: 100%; margin-top: 20px; 
      box-shadow: 0 6px 20px rgba(231,76,60,0.4); 
      transition: 0.3s; 
    }
    .submit-btn:hover { background: #c0392b; }
    .hidden { display: none; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

  <div class="container">
    <h1>سجل يومي للموظف</h1>
    <p class="date">التاريخ: <span id="today"></span></p>

    <form id="dailyForm">

      <!-- معلومات الموظف -->
      <div class="card">
        <h3>معلومات الموظف</h3>
        <input type="text" id="empName" placeholder="اسم الموظف" required />
        <input type="text" id="empPhone" placeholder="رقم الجوال" required />
      </div>

      <!-- المهام -->
      <div class="card">
        <h3>المهام <button type="button" class="toggle" onclick="toggle('tasks')">إيقاف</button></h3>
        <div id="tasks">
          <div class="task-section section">
            <div class="row">
              <input type="text" class="time" placeholder="الوقت (مثل: 9:00-11:00)" required />
              <input type="text" class="project" placeholder="المشروع" required />
            </div>
            <input type="text" class="details" placeholder="تفاصيل المهمة" required />
            <input type="text" class="done" placeholder="نسبة الإنجاز (مثل: 80%)" required />
          </div>
          <button type="button" class="add-btn" onclick="addTask()">+</button>
        </div>
      </div>

      <!-- المصروفات -->
      <div class="card">
        <h3>المصروفات <button type="button" class="toggle" onclick="toggle('expenses')">إيقاف</button></h3>
        <div id="expenses">
          <div class="expense-section section">
            <input type="text" class="e-project" placeholder="المشروع / الموقع" required />
            <input type="text" class="e-amount" placeholder="المبلغ" required />
            <input type="text" class="e-desc" placeholder="بيان الصرف" required />
            <input type="text" class="e-to" placeholder="لمن تم الصرف" required />
            <input type="text" class="e-receipt" placeholder="رابط الإيصال (اختياري)" />
          </div>
          <button type="button" class="add-btn" onclick="addExpense()">+</button>
        </div>
      </div>

      <!-- الصعوبات -->
      <div class="card">
        <h3>الصعوبات <button type="button" class="toggle" onclick="toggle('difficulties')">إيقاف</button></h3>
        <div id="difficulties">
          <div class="diff-section section">
            <input type="text" class="d-issue" placeholder="الصعوبة" required />
            <input type="text" class="d-need" placeholder="الاحتياج" required />
            <input type="text" class="d-suggest" placeholder="الاقتراح" required />
          </div>
          <button type="button" class="add-btn" onclick="addDiff()">+</button>
        </div>
      </div>

      <button type="submit" class="submit-btn">إرسال السجل</button>
    </form>
  </div>

  <script>
    document.getElementById('today').textContent = new Date().toLocaleDateString('ar-SA');

    const status = { tasks: true, expenses: true, difficulties: true };

    function toggle(id) {
      status[id] = !status[id];
      const el = document.getElementById(id);
      const btn = el.parentElement.querySelector('.toggle');
      el.style.display = status[id] ? 'block' : 'none';
      btn.textContent = status[id] ? 'إيقاف' : 'تفعيل';
      el.querySelectorAll('input').forEach(i => i.required = status[id]);
    }

    function addSection(containerId, templateClass) {
      const container = document.getElementById(containerId);
      const template = container.querySelector(`.${templateClass}`).cloneNode(true);
      const inputs = template.querySelectorAll('input');
      inputs.forEach(i => { i.value = ''; i.required = status[containerId]; });
      container.insertBefore(template, container.querySelector('.add-btn'));
    }

    function addTask() { addSection('tasks', 'task-section'); }
    function addExpense() { addSection('expenses', 'expense-section'); }
    function addDiff() { addSection('difficulties', 'diff-section'); }

    document.getElementById('dailyForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const tasks = [];
      if (status.tasks) {
        document.querySelectorAll('.task-section').forEach(sec => {
          tasks.push({
            "وقت المهمة": sec.querySelector('.time').value,
            "مشروع المهمة": sec.querySelector('.project').value,
            "تفاصيل المهمة": sec.querySelector('.details').value,
            "نسبة الإنجاز": sec.querySelector('.done').value
          });
        });
      }

      const expenses = [];
      if (status.expenses) {
        document.querySelectorAll('.expense-section').forEach(sec => {
          expenses.push({
            "مشروع المصروف": sec.querySelector('.e-project').value,
            "مبلغ المصروف": sec.querySelector('.e-amount').value,
            "بيان المصروف": sec.querySelector('.e-desc').value,
            "لمن تم الصرف": sec.querySelector('.e-to').value,
            "رابط الإيصال": sec.querySelector('.e-receipt').value
          });
        });
      }

      const difficulties = [];
      if (status.difficulties) {
        document.querySelectorAll('.diff-section').forEach(sec => {
          difficulties.push({
            "الصعوبة": sec.querySelector('.d-issue').value,
            "الاحتياج": sec.querySelector('.d-need').value,
            "الاقتراح": sec.querySelector('.d-suggest').value
          });
        });
      }

      // حساب أقصى عدد من الإضافات
      const maxLen = Math.max(tasks.length, expenses.length, difficulties.length);

      const finalData = [];
      for (let i = 0; i < maxLen; i++) {
        const row = {
          "التاريخ": new Date().toLocaleDateString('ar-SA'),
          "اسم الموظف": document.getElementById('empName').value,
          "رقم الجوال": document.getElementById('empPhone').value,
        };

        if (i < tasks.length) {
          Object.assign(row, tasks[i]);
        }

        if (i < expenses.length) {
          Object.assign(row, expenses[i]);
        }

        if (i < difficulties.length) {
          Object.assign(row, difficulties[i]);
        }

        finalData.push(row);
      }

      const API_URL = "https://sheetdb.io/api/v1/bjlibkqajiim6"; // غيّر برابطك

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: finalData })
        });
        const result = await res.json();
        if (result.created >= 1) {
          alert(`تم إرسال ${finalData.length} صفوف بنجاح!`);
          document.getElementById('dailyForm').reset();
        } else {
          alert('فشل الإرسال.');
        }
      } catch (err) {
        alert('خطأ في الاتصال.');
      }
    });
  </script>
</body>
</html>